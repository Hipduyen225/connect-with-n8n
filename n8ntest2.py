import streamlit as st
import requests
import uuid
from PyPDF2 import PdfReader  # Import th∆∞ vi·ªán x·ª≠ l√Ω PDF

# Webhook URL ƒë√∫ng (production)
WEBHOOK_URL = "https://n8n.khtt.online/webhook/cvdataset"

# Header Auth ƒë√∫ng v·ªõi n8n
HEADERS = {
    "phuongduyen": "phuongduyentestcvdataset",  # Thay b·∫±ng ƒë√∫ng token b·∫°n ƒë√£ nh·∫≠p ·ªü n8n
    "Content-Type": "application/json"
}

def generate_session_id():
    """
    Generate a unique session ID using UUID.
    """
    return str(uuid.uuid4())

def send_message_to_llm(session_id, user_message):
    """
    G·ª≠i tin nh·∫Øn ng∆∞·ªùi d√πng ƒë·∫øn webhook v√† nh·∫≠n ph·∫£n h·ªìi t·ª´ AI.
    """
    try:
        payload = {
            "sessionId": session_id,
            "chatInput": user_message
        }

        # G·ª≠i request v·ªõi header ƒë√∫ng
        response = requests.post(WEBHOOK_URL, json=payload, headers=HEADERS)
        response.raise_for_status()

        return response.json().get('output', 'No response received')

    except requests.RequestException as e:
        st.error(f"Error sending message to LLM: {e}")
        return "Sorry, there was an error processing your message."

def read_pdfs(pdf_files):
    """
    ƒê·ªçc nhi·ªÅu file PDF v√† tr·∫£ v·ªÅ vƒÉn b·∫£n t·ª´ c√°c file ƒë√≥.
    """
    text = ""
    for pdf in pdf_files:
        pdf_reader = PdfReader(pdf)
        for page in pdf_reader.pages:
            text += page.extract_text()
    return text

def main():
    """
    ·ª®ng d·ª•ng ch√≠nh c·ªßa chatbot CV AI v·ªõi ph·∫ßn upload nhi·ªÅu file PDF.
    """
    st.set_page_config(page_title="CV Recruitment AI", page_icon="üíº")

    if 'session_id' not in st.session_state:
        st.session_state.session_id = generate_session_id()

    if 'chat_history' not in st.session_state:
        st.session_state.chat_history = []

    st.title("üíº CV Recruitment AI Assistant")
    st.write("An AI assistant to help find the most suitable candidates for your job description.")

    # Hi·ªÉn th·ªã l·ªãch s·ª≠ chat
    for message in st.session_state.chat_history:
        with st.chat_message(message['role']):
            st.markdown(message['content'])

    # X·ª≠ l√Ω input c·ªßa ng∆∞·ªùi d√πng
    if prompt := st.chat_input("Enter your job description or candidate search query"):
        st.session_state.chat_history.append({
            'role': 'user',
            'content': prompt
        })

        with st.chat_message('user'):
            st.markdown(prompt)

        with st.chat_message('assistant'):
            with st.spinner('Searching for matching candidates...'):
                llm_response = send_message_to_llm(
                    st.session_state.session_id,
                    prompt
                )
                st.markdown(llm_response)

        st.session_state.chat_history.append({
            'role': 'assistant',
            'content': llm_response
        })

    # Ph·∫ßn sidebar ƒë·ªÉ upload nhi·ªÅu file PDF
    with st.sidebar:
        st.title("Upload PDFs")
        pdf_docs = st.file_uploader("Upload your PDF files", accept_multiple_files=True, type='pdf')
        if st.button("Submit & Process"):
            if pdf_docs:
                with st.spinner("Processing PDFs..."):
                    raw_text = read_pdfs(pdf_docs)  # ƒê·ªçc v√† k·∫øt h·ª£p vƒÉn b·∫£n t·ª´ nhi·ªÅu file PDF
                    st.success("Processing Complete!")
                    st.write("Extracted text from PDFs:")
                    st.write(raw_text[:500])  # Hi·ªÉn th·ªã m·ªôt ph·∫ßn vƒÉn b·∫£n ƒë√£ ƒë∆∞·ª£c tr√≠ch xu·∫•t
            else:
                st.warning("Please upload some PDF files.")

if __name__ == "__main__":
    main()
